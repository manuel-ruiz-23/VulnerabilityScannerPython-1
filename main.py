from flask import Flask, Response, jsonify, request
from lib.utils.Scanner import Scanner
import json
import threading

app = Flask(__name__)

@app.route('/', methods=['POST'])
def hello_world():
    return 'Web Vulnerabilities Scanner'


@app.route('/scanner/start', methods=['POST'])
def start():
    request_data = request.get_json()
    if valid_json_format(request_data):
        url = request_data['url']
        vulnerabilities = request_data['vulnerabilities']
        id_scann = request_data['idScann']
        auth_token = request_data['Authentication_Token']
        Scan = Scanner(url, vulnerabilities, id_scann, auth_token)
        new_scan = threading.Thread(target=Scan.start)
        new_scan.setDaemon(True)
        new_scan.start()
        return Response(json.dumps("{'status':'working'}"), status=200, mimetype="application/json")
    else:
        return Response(json.dumps("{'status':'json_error'}"), status=200, mimetype="application/json")


def valid_json_format(request_json):
    if "url" in request_json and "vulnerabilities" in request_json and "Authentication_Token" in request_json and "idScann" in request_json:
        return True
    else:
        return False


app.run(host='0.0.0.0')
